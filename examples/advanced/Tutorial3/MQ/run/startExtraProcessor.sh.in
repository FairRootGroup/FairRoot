#!/bin/bash

# buffSize="500000000" # nanomsg buffer size is in bytes
buffSize="100" # zeromq high-water mark is in messages

echo "Supported data formats: binary, boost, boost-text, flatbuffers, msgpack, protobuf, tmessage"
dataFormat="binary"
if [ "$1" = "binary" ]; then
    echo "Using: binary"
elif [ "$1" = "boost" ]; then
    dataFormat="boost"
    echo "Using: boost (Boost binary)"
elif [ "$1" = "boost-text" ]; then
    dataFormat="boost-text"
    echo "Using: boost-text (Boost text)"
elif [ "$1" = "flatbuffers" ]; then
    if(@FLATBUFFERS_FOUND@); then
        dataFormat="flatbuffers"
        echo "Using: flatbuffers (Google FlatBuffers)"
    else
        echo "Cannot use flatbuffers: library not found at build time"
        exit 1
    fi
elif [ "$1" = "msgpack" ]; then
    if(@MSGPACK_FOUND@); then
        dataFormat="msgpack"
        echo "Using: msgpack (MessagePack)"
    else
        echo "Cannot use msgpack: library not found at build time"
        exit 1
    fi
elif [ "$1" = "protobuf" ]; then
    dataFormat="protobuf"
    echo "Using: protobuf (Google Protocol Buffers)"
elif [ "$1" = "tmessage" ]; then
    dataFormat="tmessage"
    echo "Using: tmessage (Root TMessage)"
else
    echo "None or incorrect data format provided!"
    echo "Using: binary"
fi

ID="310"
processorTask="FairTestDetectorMQRecoTask" # 'FairTestDetectorMQRecoTask' is default
inputSocketType="pull"
inputBufSize=$buffSize
inputMethod="connect"
inputAddress="tcp://localhost:5566"
outputSocketType="push"
outputBufSize=$buffSize
outputMethod="connect"
outputAddress="tcp://localhost:5567"

counter=0

while [ $counter -lt $2 ]
do
    xterm -hold -e @CMAKE_BINARY_DIR@/bin/testDetectorProcessor --id $((ID+counter)) --data-format $dataFormat --input-socket-type $inputSocketType --input-buff-size $inputBufSize --input-method $inputMethod --input-address $inputAddress --output-socket-type $outputSocketType --output-buff-size $outputBufSize --output-method $outputMethod --output-address $outputAddress &
    counter=$(( $counter + 1 ))
done
