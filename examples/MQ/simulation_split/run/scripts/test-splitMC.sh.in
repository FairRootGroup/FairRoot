#!/bin/bash

source $ROOTSYS/DDS_env.sh

echo "***** Start dds server"
dds-server start -s &> dds-server.dat

cat dds-server.dat
DDS_ID=$(cat dds-server.dat | grep "Set default" | awk '{print $NF}' )

echo "***** Create local cluster with 10 agents"
dds-submit -s $DDS_ID -r localhost -n 10 &> dds-agents.dat
cat dds-agents.dat

#wait 5 seconds to start agents
COUNTER=0
LOOPING=1
until [ $LOOPING -eq 0 ]; do
    sleep 1;
    echo "waiting $COUNTER seconds to start 10 agents ";
    ((COUNTER++));
    if [ $COUNTER -ge 5 ]; then LOOPING=0; fi
    if dds-info -s $DDS_ID -n | grep -m 1 "10"; then LOOPING=0; fi
    : ;
done

echo "***** Print number of agents available"
NOFAGENTS=$(dds-info -s $DDS_ID -n)
echo $NOFAGENTS
if [ $NOFAGENTS -lt 10 ]; then
    echo "Not enough agents. Exiting"
    dds-server stop $DDS_ID
    exit
fi

echo "***** Activate topology"
dds-topology -s $DDS_ID --activate @SPLITMC_BIN_LOCATION@/test-splitMC.xml --disable-validation

#wait 20 seconds to finish jobs
COUNTER=0
LOOPING=1
until [ $LOOPING -eq 0 ]; do
    echo "waiting $COUNTER seconds for the output file to grow";
    ((COUNTER++));
    if [ $COUNTER -ge 20 ]; then LOOPING=0; fi
    FILESIZE=0
    if [ -f @SPLITMC_FILE_LOCATION@/examples/MQ/simulation_split/run/scripts/DDS.simulation_TGeant3.data.$DDS_ID.root ]; then
        FILESIZE=$(ls -l @SPLITMC_FILE_LOCATION@/examples/MQ/simulation_split/run/scripts/DDS.simulation_TGeant3.data.$DDS_ID.root | awk '{print $5}')
    fi
    fairmq-dds-command-ui -s $DDS_ID -c c
    if [ $FILESIZE -ge 100 ]; then LOOPING=0; fi
    sleep 1;
    : ;
done

echo "print Transporter logs"
#cat dds-agents.dat | grep "Starting DDSScout" | sed -e "s#\'##g" | awk '{print $8}'
AGENTS_WORK_DIR=$(cat dds-agents.dat | grep "Starting DDSScout" | sed -e "s#\'##g" | awk '{print $8}')
echo "want to get logs from $AGENTS_WORK_DIR"
find $AGENTS_WORK_DIR*  -name "Trans*log" | xargs -I {} cat {}
echo "print Transporter logs"

echo "***** Stop DDS"
dds-server stop $DDS_ID

echo "***** Check the output file"
ls -ltrh @SPLITMC_FILE_LOCATION@/examples/MQ/simulation_split/run/scripts/DDS.simulation_TGeant3.data.$DDS_ID.root
OUTPUT_EVENTS="$(echo "cout<<cbmsim->GetEntries()<<endl;" | root -l -b @SPLITMC_FILE_LOCATION@/examples/MQ/simulation_split/run/scripts/DDS.simulation_TGeant3.data.$DDS_ID.root | tail -1)"
echo "There are $OUTPUT_EVENTS events in the output file."

if (( $OUTPUT_EVENTS == 1 ));
then
    echo "Shell script finished successfully.";
else
    echo "Shell script failed."
fi
